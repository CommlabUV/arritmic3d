<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.27">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="CoMMLab">
<meta name="dcterms.date" content="2026-01-01">

<title>Arritmic3D: A fast Eikonal computational model for electrophysiology simulation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-ed96de9b727972fe78a7b5d16c58bf87.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-4248605eee59dc0e704e26d16b9f13bf.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="index_files/libs/quarto-contrib/videojs/video.min.js"></script>
<link href="index_files/libs/quarto-contrib/videojs/video-js.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#installation" id="toc-installation" class="nav-link active" data-scroll-target="#installation">Installation</a></li>
  <li><a href="#an-overview-of-arritmic3d" id="toc-an-overview-of-arritmic3d" class="nav-link" data-scroll-target="#an-overview-of-arritmic3d">An overview of Arritmic3D</a></li>
  <li><a href="#quick-start-example" id="toc-quick-start-example" class="nav-link" data-scroll-target="#quick-start-example">Quick start example</a>
  <ul class="collapse">
  <li><a href="#inspection-of-the-test-case" id="toc-inspection-of-the-test-case" class="nav-link" data-scroll-target="#inspection-of-the-test-case">Inspection of the test case</a></li>
  <li><a href="#running-existing-cases" id="toc-running-existing-cases" class="nav-link" data-scroll-target="#running-existing-cases">Running existing cases</a></li>
  </ul></li>
  <li><a href="#simulation-output" id="toc-simulation-output" class="nav-link" data-scroll-target="#simulation-output">Simulation output</a></li>
  <li><a href="#runing-simulations" id="toc-runing-simulations" class="nav-link" data-scroll-target="#runing-simulations">Runing simulations</a>
  <ul class="collapse">
  <li><a href="#definition-of-the-simulation-domain" id="toc-definition-of-the-simulation-domain" class="nav-link" data-scroll-target="#definition-of-the-simulation-domain">Definition of the simulation domain</a></li>
  <li><a href="#setting-configuration-parameters" id="toc-setting-configuration-parameters" class="nav-link" data-scroll-target="#setting-configuration-parameters">Setting configuration parameters</a></li>
  <li><a href="#backup-of-the-run-configuration" id="toc-backup-of-the-run-configuration" class="nav-link" data-scroll-target="#backup-of-the-run-configuration">Backup of the run configuration</a></li>
  </ul></li>
  <li><a href="#sec-config-file" id="toc-sec-config-file" class="nav-link" data-scroll-target="#sec-config-file">The configuration file</a>
  <ul class="collapse">
  <li><a href="#sec-stimulation-protocols" id="toc-sec-stimulation-protocols" class="nav-link" data-scroll-target="#sec-stimulation-protocols">Defining stimulation protocols</a></li>
  <li><a href="#activating-by-node-id-time" id="toc-activating-by-node-id-time" class="nav-link" data-scroll-target="#activating-by-node-id-time">Activating by node id + time</a></li>
  </ul></li>
  <li><a href="#definition-of-restitution-models" id="toc-definition-of-restitution-models" class="nav-link" data-scroll-target="#definition-of-restitution-models">Definition of restitution models</a>
  <ul class="collapse">
  <li><a href="#mapping-tissue-region-types-to-restitution-model-files" id="toc-mapping-tissue-region-types-to-restitution-model-files" class="nav-link" data-scroll-target="#mapping-tissue-region-types-to-restitution-model-files">Mapping tissue region-types to restitution model files</a></li>
  </ul></li>
  <li><a href="#generating-tissue-slabs" id="toc-generating-tissue-slabs" class="nav-link" data-scroll-target="#generating-tissue-slabs">Generating tissue slabs</a>
  <ul class="collapse">
  <li><a href="#setting-default-values-for-point-data-fields" id="toc-setting-default-values-for-point-data-fields" class="nav-link" data-scroll-target="#setting-default-values-for-point-data-fields">Setting default values for point data fields</a></li>
  <li><a href="#modifying-properties-by-region" id="toc-modifying-properties-by-region" class="nav-link" data-scroll-target="#modifying-properties-by-region">Modifying properties by region</a></li>
  <li><a href="#gradient-support-for-geometric-regions" id="toc-gradient-support-for-geometric-regions" class="nav-link" data-scroll-target="#gradient-support-for-geometric-regions">Gradient support for geometric regions</a></li>
  </ul></li>
  <li><a href="#direct-execution-of-tissue-slabs" id="toc-direct-execution-of-tissue-slabs" class="nav-link" data-scroll-target="#direct-execution-of-tissue-slabs">Direct execution of tissue slabs</a></li>
  <li><a href="#related-research" id="toc-related-research" class="nav-link" data-scroll-target="#related-research">Related research</a></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Arritmic3D: A fast Eikonal computational model for electrophysiology simulation</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>CoMMLab </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 1, 2026</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Arritmic3D is a fast Eikonal computational model for electrophysiology simulation.</p>
<p>The simulator has three versions in separate branches: branch <code>main</code> (this branch), with a development version, branch <code>ventricle</code>, with the ventricle version, and branch <code>atria</code>, with the atria version. Checkout the desired branch before proceeding.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>This development branch is not fully functional and has some differences in the diffusion model with respect to the other two branches. Thus, <strong>this branch is not validated and should not be used for research purposes yet</strong>.</p>
</div>
</div>
<p>The original version of the solver was developed in the Java environment <a href="https://processing.org/">Processing</a>. Now it is being migrated to C++ and provided with a Python interface.</p>
<section id="installation" class="level1">
<h1>Installation</h1>
<p>Right now, you need to compile the wheel yourself. To compile it you need a standard C++17 compiler, Eigen and Pybind11 installed in your system.</p>
<p>As a reference, in an ubuntu machine it should be enough to run:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install <span class="dt">\</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    build-essential <span class="dt">\</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    pkg-config <span class="dt">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    cmake <span class="dt">\</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    python3-dev <span class="dt">\</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    gcc <span class="dt">\</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    g++ <span class="dt">\</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    libeigen3-dev <span class="dt">\</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    python3-pybind11</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Then, clone the repository and compile the wheel by running:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> pip install .</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This command assumes that you have the build prerequisites installed in your python distribution. Namely, you need <code>setuptools</code> and <code>wheel</code>. You can install them using pip:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> pip install <span class="at">--upgrade</span> pip setuptools wheel</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="an-overview-of-arritmic3d" class="level1">
<h1>An overview of Arritmic3D</h1>
<p>The solver is presented as a C++ library with a Python interface. The main script to run simulations is <code>arritmic3d</code>. Typically, you will need a VTK file with the definition of the tissue to simulate and a configuration file.</p>
<p>The simulator expects a rectangular 3-dimensional domain, defined by a uniform grid. Each node in this grid is taken as a portion of cardiac tissue with its activation and conduction properties. These properties, which define the dynamics of electrophysiology of the tissue, are determined by a set of restitution models, that describe how the tissue behaves after a depolarization.</p>
<p>To use complex geometric domains, such as anatomical models of the heart, the rectangular domain can include void regions that do not belong to the tissue. These regions are defined by assigning a special restitution model index (0) to the corresponding nodes.</p>
<p>The simulator relies on a catalog of restitution models and each node is assigned a model from this catalog. Arritmic3D comes with two models (Ten Tuscher and TorOrd), but new models can be added as discussed below. The simulator requires a scalar field defined on the simulation domain that establishes which model has to be used in each node of the domain.</p>
<p>Cardiac tissue is known for having an anisotropic behavior. Fiber orientation can also be set per node, indicatig the direction along which activation propagates fastest. This parameter is optional, and isotropic behavior is simulated in its absence.</p>
<p>Finally, the simulation requires a series of external activations at certain tissue locations to start the propagation. In order to ease this task, activation regions can be defined, along with different stimulation protocols to be applied on a particular region.</p>
<p>A detailed description of the configuration parameters and input requirements is provided later. However, first we present a brief overview of how to run some basic examples.</p>
</section>
<section id="quick-start-example" class="level1">
<h1>Quick start example</h1>
<p>The python script allows the execution of a simulation on a rectilinear grid (slab) with an S1-S2 protocol. You can just run the following command:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> <span class="at">--test</span> test_case/</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-caution callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Caution
</div>
</div>
<div class="callout-body-container callout-body">
<p>The case directory must not exist or be empty prior to running the command.</p>
</div>
</div>
<div id="fig-test-case-video" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-test-case-video-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-video"><video id="video_shortcode_videojs_video1" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title=""><source src="figures/test_case_animation.mp4"></video></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-test-case-video-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Resulting simulation. Blue means inactive and red means active.
</figcaption>
</figure>
</div>
<p>This command will run a simulation on a slab with some predefined parameters, applying an S1-S2 protocol with a first base cycle length (BCL) of 800 ms and a second BCL of 400 ms. The simulation will last for 3500 ms, and the results will be saved in the <code>test_case/</code> directory in the form of a series of VTK files.</p>
<p>By running this example, you will have an idea of how the simulator works and the type of output it generates. In addition to the simulation result, <code>arritmic3d</code> will generate a configuration JSON file in the case directory, as well as a vtk with the input simulation domain in <code>test_case/input_data</code>, which you can use as a starting point for your own simulations. You can modify the configuration parameters to explore different scenarios.</p>
<section id="inspection-of-the-test-case" class="level2">
<h2 class="anchored" data-anchor-id="inspection-of-the-test-case">Inspection of the test case</h2>
<p>You can inspect the generated VTK files using <a href="https://www.paraview.org/">ParaView</a>.</p>
<p>Open the input VTK file, located in <code>test_case/input_data/slab_input.vtk</code>, to see the simulation domain. The slab is a rectangular grid with a uniform distribution of nodes. You can visualize the <code>restitution_model</code> point data field to see which restitution model is assigned to each node.</p>
<p>The domain is a rectangle that spans in the XY plane, with a small thickness in the Z direction. The slab has an outer layer of nodes with <code>restitution_model</code> equal to 0, which represent non-tissue. You can view the tissue region by applying a threshold filter to show only nodes with <code>restitution_model</code> greater than 0. The rest of the nodes have <code>restitution_model</code> equal to 1, indicating that they belong to tissue and will use the Ten Tuscher restitution model for healthy endocardium. <a href="#fig-test-case-threshold-paraview" class="quarto-xref">Figure&nbsp;2</a> shows the slab with the threshold applied. The arrows indicate the parameters that need to be set to visualize the tissue region.</p>
<div id="fig-test-case-threshold-paraview" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-test-case-threshold-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/input_slab.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-test-case-threshold-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: The input slab, visualized in Paraview. You will need to apply a threshold filter to see the tissue region that is hidden under a layer of non-tissue nodes (with <code>restitution_model</code> equal to 0).
</figcaption>
</figure>
</div>
<p>If we change the coloring to the <code>activation_region</code> field, we can see the activation region defined for the S1-S2 protocol. In this case, the south side of the slab (the nodes with lowest Y value) has been assigned <code>activation_region</code> equal to 1, indicating that it is the pacing site for the protocol. <a href="#fig-test-case-activation-region-paraview" class="quarto-xref">Figure&nbsp;3</a> shows the slab with the activation region highlighted.</p>
<div id="fig-test-case-activation-region-paraview" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-test-case-activation-region-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/input_slab_region.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-test-case-activation-region-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: The input slab visualized in ParaView, showing the activation region. The lower portion of the slab is highlighted in orange/red, indicating the activation region assigned ID 1.
</figcaption>
</figure>
</div>
<p>Now, we can open the sequence of VTK files generated as output of the simulation. These files are located in the <code>test_case/</code> directory. Each file corresponds to an instant of time in the simulation and contains different point data fields. If we apply the same threshold as before, we can visualize the activation wavefront propagating through the tissue. Make sure to hide the input slab. You can press the <em>play</em> button in ParaView to see the time evolution of the activation. <a href="#fig-test-case-wavefront-paraview" class="quarto-xref">Figure&nbsp;4</a> shows the slab with the activation wavefront visible.</p>
<div id="fig-test-case-wavefront-paraview" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-test-case-wavefront-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="figures/output_slab_wavefront.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-test-case-wavefront-paraview-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: A snapshot of the activation wavefront propagating through the tissue, visualized in ParaView.
</figcaption>
</figure>
</div>
<p>In the test case you will also find the configuration file used for the simulation, located at <code>test_case/arr3D_config_run.json</code>. In it, you will find parameters to determine the restutution models, the input file or the simulation duration, among others. The stimulation protocol is defined in the <code>PROTOCOL</code> section of the configuration file.</p>
</section>
<section id="running-existing-cases" class="level2">
<h2 class="anchored" data-anchor-id="running-existing-cases">Running existing cases</h2>
<p>Now that we have a a basic case, we can use it as a template for other simulations. The first thing we can do is to run the same case again, as is. To do so, we can run the following command:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> test_case/</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This command will run the simulation again, using the same configuration file and input data as before. The results will be saved in the <code>test_case/</code> directory, overwriting the previous results. You can open the new VTK files in ParaView to see the results, which should be identical to the previous run.</p>
<p>Now, let’s modify some parameters in the configuration file to see how they affect the simulation. For example, we can change the simulation duration to 2500 ms and the VTK output period to 5 ms. and reduce the BCL of the pacing protocol to 600ms and 300ms.</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>arr3D_config_run.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6" data-filename="arr3D_config_run.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="er">...</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"SIMULATION_DURATION"</span><span class="fu">:</span> <span class="dv">2500</span><span class="fu">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"VTK_OUTPUT_PERIOD"</span><span class="fu">:</span> <span class="dv">10</span><span class="fu">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"PROTOCOL"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>            <span class="er">...</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">600</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">]</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Then, run again the simulation with the same command. Since we now have higher temporal resolution in the output, we will be able to see the activation wavefront more clearly in ParaView.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> test_case</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div id="fig-test-video-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-test-video-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-video"><video id="video_shortcode_videojs_video2" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title=""><source src="figures/test_case_2_animation.mp4"></video></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-test-video-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: Resulting simulation with the new parameters.
</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>VTK files from the previous run may be present inside the case directory. Make sure to delete them before running the new simulation</p>
</div>
</div>
</section>
</section>
<section id="simulation-output" class="level1">
<h1>Simulation output</h1>
<p>During the simulation, VTK files are written to the case directory with the pattern:</p>
<ul>
<li><code>&lt;input_basename&gt;_&lt;time&gt;.vtk</code> (e.g., <code>slab_100.vtk</code>, <code>slab_200.vtk</code>, …)</li>
</ul>
<p>Each VTK contains the following point data fields:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 16%">
<col style="width: 83%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>State</code></td>
<td style="text-align: left;">Current cell state. 0 means inactive and 2 means active.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>APD</code></td>
<td style="text-align: left;">Action potential duration.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>DI</code></td>
<td style="text-align: left;">Diastolic inverval.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>LastDI</code></td>
<td style="text-align: left;">Last diastolic interval used in the computation of the APD.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CV</code></td>
<td style="text-align: left;">Conduction velocity.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>LAT</code></td>
<td style="text-align: left;">Local activation time.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>LifeTime</code></td>
<td style="text-align: left;">Cumulative time since last activation.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>Beat</code></td>
<td style="text-align: left;">Beat counter per cell</td>
</tr>
</tbody>
</table>
<p>The output cadence is controlled by <code>VTK_OUTPUT_PERIOD</code>, and it can be enabled/disabled via <code>VTK_OUTPUT_SAVE</code>.</p>
</section>
<section id="runing-simulations" class="level1">
<h1>Runing simulations</h1>
<p>Once we have an overall idea of how Arritmic3D works, we present a more detailed explanation of how to run simulations. To simulate a case using <code>arritmic3d</code>, you need:</p>
<ul>
<li>A VTK file containing a <code>RectilinearGrid</code> with at least the required <strong>point data</strong> field <code>restitution_model</code>.</li>
<li>A case directory to write results.</li>
<li>A configuration file in JSON format.</li>
<li>A set of restitution models, in the form of several CSV files.</li>
</ul>
<p>The program is invoked from the command line by passing the case directory as an argument:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> <span class="op">&lt;</span>case_directory<span class="op">&gt;</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>It will look for the configuration file inside <code>case_directory</code>. In the configuration file, <code>VTK_INPUT_FILE</code> sets the input file that defines the simulation domain.</p>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Units
</div>
</div>
<div class="callout-body-container callout-body">
<p>The simulator is unit agnostic, and you can use any set of units provided that you are consistent across all inputs and parameters.</p>
<p>However, note that the default configuration <strong>and restitution</strong> models for APD and CV are defined in milliseconds and in millimeters per millisecond. Therefore if you want to change the units you will need to adapt the restitution models accordingly.</p>
</div>
</div>
<section id="definition-of-the-simulation-domain" class="level2">
<h2 class="anchored" data-anchor-id="definition-of-the-simulation-domain">Definition of the simulation domain</h2>
<p>For the Python interface, this domain definition is done using an input VTK file. The input VTK file has to store a <code>RectilinearGrid</code> that includes, at least, the following point data field:</p>
<ul>
<li><strong>restitution_model</strong>: An integer field indicating the restitution model to be used for each cell. This field is used to define the cells that belong to tissue and to select the restitution model for each cell. Nodes with <code>restitution_model</code> equal to 0 are considered non-tissue (void). The value for tissue regions starts from 1 upwards. The mapping between <code>restitution_model</code> values and the corresponding restitution model files is defined in a separate CSV file specified in the configuration, as described in <a href="#sec-config-file" class="quarto-xref">Section&nbsp;6</a>.</li>
</ul>
<p>Additionally the following optional point data fields can be defined:</p>
<ul>
<li><strong>fibers_orientation</strong>: A 3-component vector field representing the orientation of the fibers in each cell. To define isotropic conduction, set all components to zero. If this field is not present, isotropic conduction is assumed for all cells.</li>
<li><strong>activation_region</strong>: An integer field that defines different regions on the tissue where activation is wanted. This field is used to define activation regions, such as the pacing sites for a pacing protocol or the PMJs. The activation times are defined in the configuration file and can refer to these regions by ID. Activations can be explicitly prescribed at certain node IDs when defining the activation in the configuration file as described in <a href="#sec-stimulation-protocols" class="quarto-xref">Section&nbsp;6.1</a>.</li>
</ul>
</section>
<section id="setting-configuration-parameters" class="level2">
<h2 class="anchored" data-anchor-id="setting-configuration-parameters">Setting configuration parameters</h2>
<p>You can set the configuration parameters in two ways: using a configuration JSON file or passing configuration options via the command line interface (CLI).</p>
<p>By default, the program looks for a configuration JSON file in the case directory, but you can also specify a different configuration file using the <code>--config-file</code> option:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> <span class="op">&lt;</span>case_directory<span class="op">&gt;</span> --config-file path/to/config.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Configuration files are handled as follows:</p>
<ul>
<li>If <code>--config-file</code> is provided, it is used (error if it does not exist).</li>
<li>If <code>--config-file</code> is not provided, the program looks in <code>&lt;case_directory&gt;</code> (prefers <code>arr3D_config.json</code>, otherwise the first <code>*.json</code>).</li>
<li>If no JSON is found, built‑in defaults are used so that you can run without a config file.</li>
</ul>
<p>Addtionally, you can override specific configuration parameters directly from the command line using the <code>-p KEY=VALUE</code> option. This option can be used multiple times to set different parameters.</p>
<p>For instance, when we ran the test case, we modified the configuration file located in the case directory to change the frequency at which VTK files are written. Instead of modifying the file we could have changed these parameters directly from the command line as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> test_case/ <span class="at">-p</span> VTK_OUTPUT_PERIOD=5 <span class="at">-p</span> SIMULATION_DURATION=2500</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Arritmic3D would have used the configuration file in <code>test_case/</code>, but the value of <code>VTK_OUTPUT_PERIOD</code> and of <code>SIMULATION_DURATION</code> would have been overridden to 5 ms and 2500 ms respectively. In this way, you can easily modify specific parameters without changing the configuration file.</p>
<p>Arritmic3D uses the following precedence rules when combining configuration sources: CLI overrides have priority over JSON values (i.e.&nbsp;<code>-p KEY=VALUE</code> overrides the same key in the JSON), and <code>--input-file</code> overrides <code>VTK_INPUT_FILE</code> from the JSON.</p>
</section>
<section id="backup-of-the-run-configuration" class="level2">
<h2 class="anchored" data-anchor-id="backup-of-the-run-configuration">Backup of the run configuration</h2>
<p>The actual configuration used in the execution is the result of combining the base JSON (if any) with all CLI overrides (including <code>--input-file</code>). We call this the <em>run configuration</em>. For reproducibility, this exact configuration is written to disk so the run can be replicated.</p>
<p>The configuration used for the run is saved to <code>&lt;case_directory&gt;/arr3D_config_run.json</code>. You can disable saving of the run configuration with <code>--no-output-run-config</code>.</p>
<section id="paths-and-reproducibility" class="level3">
<h3 class="anchored" data-anchor-id="paths-and-reproducibility">Paths and reproducibility</h3>
<p>In order to facilitate reproducibility and sharing of cases, paths are handled as follows:</p>
<ul>
<li>All paths passed as command line arguments (e.g., <code>--config-file</code>, <code>--input-file</code>, or <code>-p KEY=VALUE</code> for path values) are interpreted relative to the current working directory.</li>
<li>Paths read from JSON files are interpreted relative to the location of the JSON file being loaded (whether from case_dir or via <code>--config-file</code>).</li>
<li>The <em>run configuration</em> saved to <code>case_dir/arr3D_config_run.json</code> converts paths and stores them relative to the case directory, to ease sharing and reproducibility.</li>
</ul>
</section>
</section>
</section>
<section id="sec-config-file" class="level1">
<h1>The configuration file</h1>
<p>The configuration file is a JSON file with the following parameters:</p>
<table class="caption-top table">
<caption>Model configuration</caption>
<colgroup>
<col style="width: 23%">
<col style="width: 76%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>CV_MODEL_CONFIG_PATH</code></td>
<td style="text-align: left;">Path to the <code>csv</code> configuration file of the conduction velocities models.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>APD_MODEL_CONFIG_PATH</code></td>
<td style="text-align: left;">Path to the <code>csv</code> configuration file of the action potential duration models.</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<caption>Electrophysiollogy and conduction parameters</caption>
<colgroup>
<col style="width: 39%">
<col style="width: 60%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>COND_VELOC_TRANSVERSAL_REDUCTION</code></td>
<td style="text-align: left;">Reduction factor for transversal conduction velocity.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>CORRECTION_FACTOR_APD</code></td>
<td style="text-align: left;">Correction factor for action potential duration (APD).</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>CORRECTION_FACTOR_CV</code></td>
<td style="text-align: left;">Correction factor for conduction velocity.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>ELECTROTONIC_EFFECT</code></td>
<td style="text-align: left;">Factor accounting for electrotonic effects in tissue.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>INITIAL_APD</code></td>
<td style="text-align: left;">Initial action potential duration.</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<caption>I/O and file management.</caption>
<thead>
<tr class="header">
<th style="text-align: left;">Field</th>
<th style="text-align: left;">Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;"><code>VTK_OUTPUT_SAVE</code></td>
<td style="text-align: left;">If <code>true</code>, saves VTK output files.</td>
</tr>
<tr class="even">
<td style="text-align: left;"><code>VTK_OUTPUT_PERIOD</code></td>
<td style="text-align: left;">Time interval between VTK outputs.</td>
</tr>
<tr class="odd">
<td style="text-align: left;"><code>VTK_INPUT_FILE</code></td>
<td style="text-align: left;">Path to the input VTK file.</td>
</tr>
</tbody>
</table>
<table class="caption-top table">
<caption>Simulation and protocol settings.</caption>
<colgroup>
<col style="width: 8%">
<col style="width: 91%">
</colgroup>
<thead>
<tr class="header">
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>SIMULATION_DURATION</code></td>
<td>Total duration of the simulation.</td>
</tr>
<tr class="even">
<td><code>PROTOCOL</code></td>
<td><p>Stimulation protocol settings, using an <span class="math inline">\(S_1,S_2,...,S_n\)</span> pacing protocol. It is a list of dictionaries, each with the following fields:</p>
<ul>
<li><code>ACTIVATION_REGION</code>: An integer indicating the activation region ID defined by the field <code>activation_region</code> in the tissue. Alternatively, it can be a list of integers that will be interpreted as node IDs where the activation will be applied.</li>
<li><code>N_STIMS_PACING</code>: List with the number of stimuli for the pacing region.</li>
<li><code>BCL</code>: List of base cycle lengths (BCL) for each pacing.</li>
<li><code>FIRST_ACTIVATION_TIME</code>: Time of the first activation for that pacing site. The first stimulus will be applied at this time, and subsequent stimuli will follow according to the BCL. Optional; if not provided, the first activation time is set to the first BCL.</li>
<li><code>FIRST_BEAT_NUM</code>: Beat number to assign to the first activation at that pacing site. Optional; if not provided, the first beat number is set to 1.</li>
</ul></td>
</tr>
<tr class="odd">
<td><code>ACTIVATE_NODES</code></td>
<td><p>List of dictionaries defining specific activation times for nodes. Each dictionary has the following fields:</p>
<ul>
<li><code>ACTIVATION_REGION</code>: An integer, referring to the nodes that have that value in the <code>activation_region</code> field of the VTK file, or a list of node IDs.</li>
<li><code>ACTIVATION_TIMES</code>: List of pairs <code>[time, beat]</code>, where <code>time</code> is the activation time in ms, and <code>beat</code> is the beat number to assign to that activation.</li>
</ul></td>
</tr>
</tbody>
</table>
<p>The definition of large activation regions and cumbersome protocols can lead to unreadable configuration files. To facilitate the definition of stimulation protocols involving many nodes with different activation times, it is possible to use <strong>external JSON files</strong>.</p>
<ul>
<li>In the <code>PROTOCOL</code> dictionary, they can be used in place of the <code>ACTIVATION_REGION</code> and <code>FIRST_ACTIVATION_TIME</code> fields. In this case, the files must contain a single JSON list with the node IDs and the first activation time, respectively. Both lists must have the same length.</li>
<li>In the <code>ACTIVATE_NODES</code> dictionary, the <code>ACTIVATION_REGION</code> field can also be replaced by an external JSON file containing a list of lists with the form <code>[ID,time,beat]</code>, where the <code>ID</code> is a node ID. In this case, the <code>ACTIVATION_TIMES</code> field is not needed and is ignored if present.</li>
</ul>
<section id="sec-stimulation-protocols" class="level2">
<h2 class="anchored" data-anchor-id="sec-stimulation-protocols">Defining stimulation protocols</h2>
<p>Next you will find some examples of how to define stimulation protocols in the configuration file.</p>
<p>Let’s start with a simple S1-S2-S3-S4 protocol example.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="er">"PROTOCOL":</span> <span class="ot">[</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span> <span class="dv">2462</span><span class="ot">,</span> <span class="dv">2861</span><span class="ot">,</span> <span class="dv">2880</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">8</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">600</span><span class="ot">,</span> <span class="dv">400</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">,</span> <span class="dv">200</span><span class="ot">]</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This example defines a protocol with pacing site formed by nodes 2443, 2462, 2861, 2880 (this points correspond to the four corners of the <span class="math inline">\(Z=1\)</span> section of the slab). The protocol consists of 8 stimuli at a BCL of 600 ms, followed by 2 stimuli at a BCL of 400 ms, then 1 stimulus at 300 ms, and finally 1 stimulus at 200 ms.</p>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Warning
</div>
</div>
<div class="callout-body-container callout-body">
<p>When activating a region using point ids, make sure this points correspond to actual cardiac tissues (they should have <code>restitution_model</code> distinct from 1).</p>
<p>If you try to activate a <em>void</em> cell, the simulator will output a warning.</p>
</div>
</div>
<div id="fig-s1s2s3s4" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-s1s2s3s4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-video"><video id="video_shortcode_videojs_video3" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title=""><source src="figures/s1s2s3s4.mp4"></video></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-s1s2s3s4-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Result of the simulation with the S1-S2-S3-S4 protocol.
</figcaption>
</figure>
</div>
<p><code>N_STIMS_PACING</code> and <code>BCL</code> lists do not need to have the same length. If they differ, the last value of the shorter list is repeated until both lists have the same length. For instance, the following is equivalent to the previous example.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="er">"PROTOCOL":</span> <span class="ot">[</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span> <span class="dv">2462</span><span class="ot">,</span> <span class="dv">2861</span><span class="ot">,</span> <span class="dv">2880</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">8</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">600</span><span class="ot">,</span> <span class="dv">400</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">,</span> <span class="dv">200</span><span class="ot">]</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note that here, <code>N_STIMS_PACING</code> has 3 values, while <code>BCL</code> has 4 values; thus, the last <code>N_STIMS_PACING</code> value (1) is repeated to match the length of the <code>BCL</code> list.</p>
<p>The activation time of the first stimulus can be set using the <code>FIRST_ACTIVATION_TIME</code> field. For example, the following protocol starts the first activation at 50 ms.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="er">"PROTOCOL":</span> <span class="ot">[</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span> <span class="dv">2462</span><span class="ot">,</span> <span class="dv">2861</span><span class="ot">,</span> <span class="dv">2880</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">8</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">600</span><span class="ot">,</span> <span class="dv">400</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"FIRST_ACTIVATION_TIME"</span><span class="fu">:</span> <span class="dv">50</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Note that using this option will not change the numer of activations, only the time at which the first activation occurs. In this case, the first activation will occur 50 ms after the simulation starts. This can generate an apparent mismatch between the first activation time and the BCL schedule. This option is an advanced setup, and is only meant to add flexibility to the protocol definition if the starting state of the tissue considers a certain activation state. That is, the previous example could be useful with a tissue that was activated 550ms before the simulation started, so that the first activation must occur at 50 ms (600ms after the last activation). If this field is not provided (which is the recommended option), the first activation time is set to the value of the first BCL (which would be 600 ms after the simulation start in the previous example). This option also admits as input a list of first activation times (one for each activation region).</p>
<p>External files can be used to reduce the size of the configuration file when the activation must be defined for each node separately. The first example can be rewritten as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="er">"PROTOCOL":</span>  <span class="ot">[</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="st">"cases/slab_test_protocol_sites_beat1.json"</span><span class="fu">,</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"FIRST_ACTIVATION_TIME"</span><span class="fu">:</span> <span class="st">"cases/slab_test_protocol_first_activation_beat1.json"</span><span class="fu">,</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">8</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">,</span> <span class="dv">1</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">600</span><span class="ot">,</span> <span class="dv">400</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">,</span> <span class="dv">300</span><span class="ot">]</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Where:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>slab_test_protocol_sites_beat1.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb15" data-filename="slab_test_protocol_sites_beat1.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span> <span class="dv">2462</span><span class="ot">,</span> <span class="dv">2861</span><span class="ot">,</span> <span class="dv">2880</span><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>slab_test_protocol_first_activation_beat1.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16" data-filename="slab_test_protocol_first_activation_beat1.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span><span class="dv">50</span><span class="ot">,</span> <span class="dv">55</span><span class="ot">,</span> <span class="dv">72</span><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>This example shows how to define different first activation times for each node in the pacing site. This can be useful, for instance, when we have the activation time at PMJs in ventricle.</p>
<p>The following example shows a protocol with two different pacing sites, each with its own activation schedule. It also illustrates the use of the <code>FIRST_BEAT_NUM</code> field to customize beat numbering. Note that the slabs we have built so far do not have multiple activation regions, so this example is only illustrative.</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="er">"PROTOCOL":</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>         <span class="fu">{</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"FIRST_ACTIVATION_TIME"</span><span class="fu">:</span> <span class="dv">100</span><span class="fu">,</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">3</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">800</span><span class="ot">,</span> <span class="dv">500</span><span class="ot">]</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">{</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="dv">2</span><span class="fu">,</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"FIRST_ACTIVATION_TIME"</span><span class="fu">:</span> <span class="dv">600</span><span class="fu">,</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"N_STIMS_PACING"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">3</span><span class="ot">,</span> <span class="dv">2</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"BCL"</span><span class="fu">:</span> <span class="ot">[</span><span class="dv">800</span><span class="ot">,</span> <span class="dv">500</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">"FIRST_BEAT_NUM"</span><span class="fu">:</span> <span class="dv">6</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">}</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Each activation is assigned a beat number, which can be used to detect reentries. When using <code>PROTOCOL</code> to activate tissue, the first activation at each pacing site is assigned beat number 1, and subsequent activations increment the beat number by 1. However, you can customize the beat numbering by using the <code>FIRST_BEAT_NUM</code> field to decide the starting beat number. This can help distinguish activations from different pacing sites or protocols. In the previous example, the beats from the first pacing site are numbered in the range 1 to 5, while the beats from the second pacing site start from beat number 6.</p>
</section>
<section id="activating-by-node-id-time" class="level2">
<h2 class="anchored" data-anchor-id="activating-by-node-id-time">Activating by node id + time</h2>
<p>Activation times can be prescribed explicitly for each node using the <code>ACTIVATE_NODES</code> parameter. <code>ACTIVATION_REGION</code> works as explained above, and <code>ACTIVATION_TIMES</code> consists of a list of pairs <code>[ACTIVATION_TIME, BEAT]</code>.</p>
<p>Here is an example:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="er">"ACTIVATE_NODES"</span> <span class="er">:</span> <span class="ot">[</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span>  <span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span> <span class="dv">2462</span><span class="ot">,</span> <span class="dv">2861</span><span class="ot">,</span> <span class="dv">2880</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"ACTIVATION_TIMES"</span><span class="fu">:</span> <span class="ot">[[</span><span class="dv">500</span><span class="ot">,</span><span class="dv">1</span><span class="ot">],[</span><span class="dv">550</span><span class="ot">,</span><span class="dv">2</span><span class="ot">]]</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"ACTIVATION_REGION"</span><span class="fu">:</span> <span class="dv">1</span><span class="fu">,</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"ACTIVATION_TIMES"</span><span class="fu">:</span> <span class="ot">[[</span><span class="dv">1500</span><span class="ot">,</span><span class="dv">4</span><span class="ot">],[</span><span class="dv">1550</span><span class="ot">,</span><span class="dv">5</span><span class="ot">]]</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This example defines specific activation times for nodes 2443, 2462, 2861, 2880 at 500 ms (beat 1) and 550 ms (beat 2), and for nodes with <code>activation_region</code> value 1 at 1500 ms (beat 4) and 1550 ms (beat 5). Note the difference between using a list of node IDs and an integer referring to the <code>activation_region</code> field in the VTK file. When using <code>ACTIVATE_NODES</code>, you must always explicitly set the beat number for each activation in the <code>ACTIVATION_TIMES</code> list.</p>
<p>External files can also be used as follows:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="er">"ACTIVATE_NODES"</span> <span class="er">:</span> <span class="ot">[</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">{</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>        <span class="dt">"ACTIVATION_REGION"</span> <span class="fu">:</span> <span class="st">"cases/slab_test_stim_nodes_beat1.json"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>where:</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>slab_test_stim_nodes_beat1.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20" data-filename="slab_test_stim_nodes_beat1.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">2443</span><span class="ot">,</span><span class="dv">500</span><span class="ot">,</span><span class="dv">1</span><span class="ot">],</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">2462</span><span class="ot">,</span><span class="dv">550</span><span class="ot">,</span><span class="dv">2</span><span class="ot">],</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">2861</span><span class="ot">,</span><span class="dv">600</span><span class="ot">,</span><span class="dv">3</span><span class="ot">],</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">[</span><span class="dv">2880</span><span class="ot">,</span><span class="dv">650</span><span class="ot">,</span><span class="dv">4</span><span class="ot">]</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>In this case, the first value in each tuple contains a node ID, the second value the activation time, and the third value the beat number.</p>
</section>
</section>
<section id="definition-of-restitution-models" class="level1">
<h1>Definition of restitution models</h1>
<p>The restitution models can be defined by means of restitution curves or surfaces, as described in <span class="citation" data-cites="serraAutomataBasedCardiacElectrophysiology2022">(<a href="#ref-serraAutomataBasedCardiacElectrophysiology2022" role="doc-biblioref">Dolors Serra, Romero, et al. 2022</a>)</span>, <span class="citation" data-cites="romittiImplementationCellularAutomaton2025">(<a href="#ref-romittiImplementationCellularAutomaton2025" role="doc-biblioref">Romitti et al. 2025</a>)</span>. A restitution curve is a function that provides the next Action Potential Duration (APD) of a cell as a function of the Diastolic Interval (DI) at activation. A restitution surface is a function that provides the next APD of a cell as a function of its last APD and the DI at activation.</p>
<p>The simulator needs a restitution model for each tissue type (representing, e.g.&nbsp;tissue region, as in endo/mid/epi, or type, such as healthy/border zone). The restitution models (curves or surfaces) are encoded as a table in a CSV file. Another CSV file must indicate the tissue region-type that is modeled in each table. Actually, all the models are treated as surfaces, even if they are curves. In that case, the table will have a single row for each previous APD value, with an ourput APD value for each DI.</p>
<p>The following CSV corresponds to a restitution model</p>
<pre class="csv"><code>0.0  , 30.0 , 35.0 , 40.0 , 45.0 , 50.0
95.5 , -1.0 , 89.44, 89.67, 89.90, 90.13
99.5 , 89.64, 89.87, 90.10, 90.32, 90.52
103.5, 90.73, 90.95, 91.17, 91.38, 91.59
107.5, 91.67, 91.88, 92.09, 92.30, 92.50</code></pre>
<p>For the restitution model CSV table shown above, the first row contains the Diastolic Interval (DI) values measured in milliseconds. The first column lists the previous Action Potential Duration (APD) values, also in milliseconds. The remaining cells in the table contain the computed next APD values in milliseconds. Note the use of -1.0 to indicate that no activation occurs for that combination of previous APD and DI.</p>
<p>Dead (Core Zone) tissue can be modeled by setting the restitution model index to 0. But, if desired, it can also be mapped to a table that always returns -1.0 for any input values.</p>
<pre class="csv"><code>0.0  , 30.0
100  , -1.0</code></pre>
<p>The actual values for DI and previous APD are not relevant in this case, as no activation will ever occur.</p>
<p>Important considerations for the restitution table format:</p>
<ul>
<li>The table must include the minimum DI value that allows cell activation, along with the preceding DI value. For the preceding value, use -1 to indicate no activation occurs. That is, in every row, at least the first column must contain -1 for the DI value that precedes the minimum activation DI value. This ensures that the model can correctly identify the threshold for activation.</li>
<li>For APD or DI input values that fall outside the table’s defined ranges, the model applies flat extrapolation to determine the output values.</li>
</ul>
<section id="mapping-tissue-region-types-to-restitution-model-files" class="level2">
<h2 class="anchored" data-anchor-id="mapping-tissue-region-types-to-restitution-model-files">Mapping tissue region-types to restitution model files</h2>
<p>The field <code>restitution_model</code> in the input VTK file indicates the tissue region-type for each cell. The value of this field is used to select the restitution model for each cell according to the mapping provided in the second CSV file.</p>
<p>To specify which tissue regions use which restitution models, a separate CSV file maps the region types to table indices. For example:</p>
<pre class="csv"><code>1 , TenTuscher_APD_BZ_Mid.csv
2 , TenTuscher_APD_BZ_Epi.csv
3 , TenTuscher_APD_Healthy_Mid.csv</code></pre>
<p>The simulator reads this configuration files from the <code>CV_MODEL_CONFIG_PATH</code> and <code>APD_MODEL_CONFIG_PATH</code> configuration parameters.</p>
<p>As discussed, index ‘0’ is reserved for non-tissue regions and cannot be used.</p>
</section>
</section>
<section id="generating-tissue-slabs" class="level1">
<h1>Generating tissue slabs</h1>
<p>Using the <code>build_slab</code> utility, you can generate a rectangular tissue domain (a tissue slab) for testing. This script creates a VTK file with the required fields for simulation.</p>
<p>For example, to generate a slab with 10 nodes in X, 10 in Y, and 5 in Z, with spacing of 0.05 mm, run:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 10 10 5 <span class="at">--spacing</span> 0.05 0.05 0.05</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>This will create a VTK file at <code>cases/slab.vtk</code> with the necessary structure and a point data field named <code>restitution_model</code> with a value of 1. You can customize the grid size, spacing, and additional options using the script arguments.</p>
<p>Note that a value of <code>nnodes</code> equal to 10 means that the slab will have 10 points in each dimension (0 to 9), resulting in a grid size of 9 * spacing in each dimension.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/generated_slab.png" class="img-fluid figure-img"></p>
<figcaption>Generated slab, colored by <code>restitution_model</code>.</figcaption>
</figure>
</div>
<section id="setting-default-values-for-point-data-fields" class="level2">
<h2 class="anchored" data-anchor-id="setting-default-values-for-point-data-fields">Setting default values for point data fields</h2>
<p>You can set default values for point data fields using the <code>--field FIELD_NAME VALUE</code> option. This option can be used multiple times to set different fields. For example, to set the default restitution model to 1 and the fibers orientation to <span class="math inline">\([1,0,0]\)</span>, run:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 20 20 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--field</span> restitution_model 1 <span class="dt">\</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--field</span> fibers_orientation <span class="pp">[</span><span class="ss">1,0,0</span><span class="pp">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/generated_slab_fibers_orientation.png" class="img-fluid figure-img"></p>
<figcaption>Generated slab. Arrows show the fibers orientation.</figcaption>
</figure>
</div>
<section id="setting-the-default-restitution-model" class="level3">
<h3 class="anchored" data-anchor-id="setting-the-default-restitution-model">Setting the default restitution model</h3>
<p>In particular, and as mentioned above, you can set the restitution model for all tissue nodes using the <code>--field</code> option. This will set the base restitution model that can be later modified using regions (see next section). For example, to set the default restitution model to 2, run:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 20 20 5 <span class="dt">\</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="at">--field</span> restitution_model 2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="modifying-properties-by-region" class="level2">
<h2 class="anchored" data-anchor-id="modifying-properties-by-region">Modifying properties by region</h2>
<p>It is possible to modify the value of any field (and, in particular, the restitution-model identifier) at the points in a particular region of the generated slab. Supported region shapes are <code>circle</code> (inner core + outer ring), <code>square</code>, and <code>diamond</code> (45°-rotated square). Each region is specified in world distance units (the same units as <code>--spacing</code>) and updates the <code>restitution_model</code> point-data field accordingly. Regions are applied in sequence and later regions overwrite earlier ones in case of overlap.</p>
<p>You can create such regions in the generated slab using the following CLI options.</p>
<ul>
<li><p><code>--regions-file PATH</code> Path to a JSON file that contains a list of region objects. Each object must be a JSON object describing a region (see schema below). The file is loaded first.</p></li>
<li><p><code>--region JSON</code> (repeatable) Add a region by passing a JSON object string on the command line. This option can be used multiple times; each occurrence appends a region. CLI regions are processed after the regions file and therefore override file regions on overlap.</p></li>
</ul>
<section id="regions-schema-and-behavior" class="level3">
<h3 class="anchored" data-anchor-id="regions-schema-and-behavior">Regions schema and behavior</h3>
<p>Each region object is a JSON object with the following schema:</p>
<ul>
<li>circle:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"circle"</span><span class="fu">,</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"cx"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"cy"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"r1"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"r2"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;field&gt;</span><span class="fu">:</span> <span class="er">scalar|</span><span class="ot">[</span><span class="er">...</span><span class="ot">]</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>square:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"square"</span><span class="fu">,</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"cx"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"cy"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"r1"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"r2"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;field&gt;</span><span class="fu">:</span> <span class="er">scalar|</span><span class="ot">[</span><span class="er">...</span><span class="ot">]</span></span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>diamond:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"diamond"</span><span class="fu">,</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"cx"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"cy"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"r1"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span> <span class="dt">"r2"</span><span class="fu">:</span><span class="er">float</span><span class="fu">,</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;field&gt;</span><span class="fu">:</span> <span class="er">scalar|</span><span class="ot">[</span><span class="er">...</span><span class="ot">]</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>side:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"side"</span><span class="fu">,</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"side"</span><span class="fu">:</span> <span class="st">"north"</span> <span class="er">|</span> <span class="st">"south"</span> <span class="er">|</span> <span class="st">"east"</span> <span class="er">|</span> <span class="st">"west"</span><span class="fu">,</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;field&gt;</span><span class="fu">:</span><span class="er">value</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>node_ids:</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"node_ids"</span><span class="fu">,</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">"ids"</span><span class="fu">:</span><span class="ot">[</span><span class="er">int</span><span class="ot">,</span><span class="er">...</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="er">&lt;field&gt;</span><span class="fu">:</span><span class="er">value</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Here, <code>&lt;field&gt;</code> can be any point data field name (e.g., <code>"restitution_model"</code>, <code>"activation_region"</code>).</p>
<p>For <code>circle/square/diamond</code>, field values can be either a scalar or a list, in which case a gradient with first element at <code>r1</code> and last at <code>r2</code> is produced.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Precedence and behavior
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>Precedence: regions are applied in this order: regions from <code>--regions-file</code> first, then regions supplied via <code>--region</code> in the order given, and finally the legacy single-region flags (<code>--add_square</code>, <code>--add_circle</code>, <code>--add_diamond</code>). Later regions overwrite earlier ones on overlap.</li>
<li>Validation: input is strictly validated. If a region object is missing required fields or has invalid types, the script raises an explanatory exception and stops..</li>
<li>Units: all coordinates and distances in region objects are interpreted in world distance units (the same units as <code>--spacing</code> and grid coordinates).</li>
</ul>
</div>
</div>
</section>
<section id="examples" class="level3">
<h3 class="anchored" data-anchor-id="examples">Examples</h3>
<p>Regions can be provided either directly through the command line:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 20 20 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">--region</span> <span class="st">'{"shape":"square","cx":0.5,"cy":0.5,"r1":0.05,"r2":0.1,"restitution_model":7}'</span> <span class="dt">\</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>   <span class="at">--region</span> <span class="st">'{"shape":"circle","cx":0.1,"cy":0.1,"r1":0.1,"r2":0.4,"restitution_model":[1,2,3]}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Using an external file</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 20 20 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>   <span class="at">--regions-file</span> ./cases/regions_example.json</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>where</p>
<div class="code-with-filename">
<div class="code-with-filename-file">
<pre><strong>regions_example.json</strong></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34" data-filename="regions_example.json"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="ot">[</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span> <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"circle"</span><span class="fu">,</span> <span class="dt">"cx"</span><span class="fu">:</span><span class="fl">0.5</span><span class="fu">,</span> <span class="dt">"cy"</span><span class="fu">:</span><span class="fl">0.5</span><span class="fu">,</span> <span class="dt">"r1"</span><span class="fu">:</span><span class="fl">0.2</span><span class="fu">,</span> <span class="dt">"r2"</span><span class="fu">:</span><span class="fl">0.4</span><span class="fu">,</span> <span class="dt">"restitution_model"</span><span class="fu">:</span><span class="ot">[</span><span class="dv">2</span><span class="ot">,</span> <span class="dv">3</span><span class="ot">]</span> <span class="fu">}</span><span class="ot">,</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">{</span> <span class="dt">"shape"</span><span class="fu">:</span><span class="st">"square"</span><span class="fu">,</span> <span class="dt">"cx"</span><span class="fu">:</span><span class="fl">1.0</span><span class="fu">,</span> <span class="dt">"cy"</span><span class="fu">:</span><span class="fl">1.0</span><span class="fu">,</span> <span class="dt">"r1"</span><span class="fu">:</span><span class="fl">0.15</span><span class="fu">,</span> <span class="dt">"r2"</span><span class="fu">:</span><span class="fl">0.3</span><span class="fu">,</span> <span class="dt">"restitution_model"</span><span class="fu">:</span><span class="ot">[</span><span class="dv">4</span><span class="ot">,</span> <span class="dv">5</span><span class="ot">]</span> <span class="fu">}</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="ot">]</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Or using a mix of both:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 40 40 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">--regions-file</span> ./cases/regions_example.json <span class="dt">\</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--region</span> <span class="st">'{"shape":"diamond","cx":1.5,"cy":1.0,"r1":0.5,"r2":0.8,"restitution_model":[9,5,4]}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="figures/generated_multiple_figures.png" class="img-fluid figure-img"></p>
<figcaption>A slab with a circular, square and diamon region. Since <code>diamond</code> was inputed last, it ovewrote the intersecting square region.</figcaption>
</figure>
</div>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>Activation regions (stimulation or pacing sites) are defined using the same region system for restitution models and other fields, targeting the <code>activation_region</code> field. Any region shape (circle, square, diamond, side, node_ids) can be used to set <code>activation_region</code> values.</p>
</div>
</div>
</section>
<section id="convenience-options-to-define-activation-regions" class="level3">
<h3 class="anchored" data-anchor-id="convenience-options-to-define-activation-regions">Convenience options to define activation regions</h3>
<p>For common activation scenarios, two convenience CLI options are provided:</p>
<ul>
<li><p><code>--region-by-side SIDE REGION_ID</code> Defines an entire slab side as an activation region. <code>SIDE</code> must be one of: <code>north</code>, <code>south</code>, <code>east</code>, <code>west</code>. <code>REGION_ID</code> is the integer value to assign to <code>activation_region</code>. This option can be repeated to activate multiple sides with different region IDs.</p></li>
<li><p><code>--region-by-node-ids NODE_ID [NODE_ID ...] REGION_ID</code> Defines a region based on specific nodes by their IDs. All arguments except the last are node IDs; the last argument is the <code>REGION_ID</code> to assign. This option can be repeated to create multiple activation groups.</p></li>
</ul>
<p>For example, you can:</p>
<ul>
<li>Activate multiple sides with different region IDs</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 50 50 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-side</span> south 1 <span class="dt">\</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-side</span> north 2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Activate specific nodes</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 50 50 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-node-ids</span> 2443 2462 2861 2880 1</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>Combine geometric regions with activations</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="ex">build_slab</span> cases/slab.vtk <span class="at">--nnodes</span> 50 50 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span> <span class="st">'{"shape":"square","cx":1.225,"cy":1.225,"r1":1.0,"r2":1.0,"size":1.0,"restitution_model":5}'</span> <span class="dt">\</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-side</span> south 1 <span class="dt">\</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-node-ids</span> 2443 2462 2861 2880 2</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>The convenience options <code>--region-by-side</code> and <code>--region-by-node-ids</code> are internally converted to region objects and applied in the same sequence as <code>--region</code> entries. Activations defined via these options are processed after <code>--regions-file</code> and <code>--region</code>, so they can overwrite previous values on overlap.</p>
</div>
</div>
</section>
</section>
<section id="gradient-support-for-geometric-regions" class="level2">
<h2 class="anchored" data-anchor-id="gradient-support-for-geometric-regions">Gradient support for geometric regions</h2>
<p>For geometric regions (circle, square, diamond), a gradient can be set for a smooth transition of field values between the inner radius <code>r1</code> and outer radius <code>r2</code>. This allows for gradual changes in properties across the region. The gradient is defined by providing a list of values for the field. The interpretation depends on the value provided:</p>
<ul>
<li><strong>Scalar</strong>: Applied uniformly at <code>r2</code> (outer radius/size).</li>
<li><strong>List</strong>: Creates a smooth transition between <code>r1</code> and <code>r2</code>. The first value of the list applies at <code>r =&lt; r1</code>, the last at <code>r2</code>, and intermediate values are set at uniform intervals between <code>r1</code> and <code>r2</code>.</li>
</ul>
<p>To set vector fields, the list can contain vectors to define a gradient of vectors. If a uniform vector is desired, provide a list with a single vector. For instance, to set a uniform fiber orientation of <code>[1,0,0]</code>, use <code>"fiber_orientation" : [ [1,0,0] ]</code>.</p>
<p>For <strong>existing vector fields</strong>, if the type of the previous field is different from the provided value, then an error is raised.</p>
<p>Single values (scalar or single value lists) are applied at <strong><code>r2</code></strong>. Also, if a list is provided but <code>r1 == r2</code>, then the first element is applied to the entire region (where <code>r =&lt; r1</code>).</p>
<p>Some examples:</p>
<ul>
<li>An uniform scalar value at <span class="math inline">\(r \leq r1\)</span></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--region</span> <span class="st">'{"shape":"circle","cx":1.0,"cy":1.0,"r1":0.2,"r2":0.2,"restitution_model":3}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>An uniform vector field at <span class="math inline">\(r \leq r1\)</span></li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--region</span> <span class="st">'{"shape":"square","cx":1.0,"cy":1.0,"r1":0.15,"r2":0.15,"fibers_orientation":[[1,0,0]]}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>A scalar gradient (3 layers interpolated between <span class="math inline">\(r1\)</span> and <span class="math inline">\(r2\)</span>)</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb41"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--region</span> <span class="st">'{"shape":"circle","cx":1.0,"cy":1.0,"r1":0.2,"r2":0.6,"restitution_model":[5,4,3]}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<ul>
<li>A gradient of vectors</li>
</ul>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb42"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">--region</span> <span class="st">'{"shape":"square","cx":0.5,"cy":0.5,"r1":0.1,"r2":0.3,"fibers_orientation":[[1,0,0],[0,1,0]]}'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<ul>
<li>In the scalar gradient <code>[5,4,3]</code>: model 5 is at <span class="math inline">\(r1=0.2\)</span>, model 4 is at midpoint (<span class="math inline">\(r \approx 0.4\)</span>) and model 3 at <span class="math inline">\(r2=0.6\)</span>.</li>
<li>For uniform application across the entire circular/square/diamond region, use <code>r1 == r2</code>.</li>
</ul>
</div>
</div>
</section>
</section>
<section id="direct-execution-of-tissue-slabs" class="level1">
<h1>Direct execution of tissue slabs</h1>
<p>The <code>arritmic3d</code> script includes a <code>--slab</code> option that allows you to directly build and run a slab simulation without needing to create the VTK file separately. This option generates a rectilinear grid slab based on the provided parameters and runs the simulation using default or specified configuration settings.</p>
<p>When using <code>--slab</code>, you can use in <code>arritmic3d</code> the same options available in <code>build_slab</code> to define the slab properties and regions. For instance:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="ex">arritmic3d</span> case_dir <span class="at">--slab</span> <span class="at">--nnodes</span> 20 20 5 <span class="at">--spacing</span> 0.05 0.05 0.05 <span class="dt">\</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region</span> <span class="st">'{"shape":"square","cx":0.5,"cy":0.5,"r1":0.05,"r2":0.1,"restitution_model":7}'</span> <span class="dt">\</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--region-by-side</span> <span class="st">'south'</span> 1 <span class="dt">\</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-p</span> ACTIVATE_NODES=<span class="st">'[{"ACTIVATION_REGION" : 1,"ACTIVATION_TIMES":[[500,1],[1000,1]]}]'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>In this example, the lower margin of the slab (south side) is defined as an activation with region ID 1, and specific activation times are defined for nodes with that region ID. Further details on defining regions and activation sites can be found in the respective sections of this README.</p>
<p>When using <code>--slab</code>, the generated VTK will be used. In this case, you are not allowed to use the <code>--input-file</code> option and any <code>VTK_INPUT_FILE</code> present in the JSON will be ignored.</p>
<div id="fig-direct-slab" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-direct-slab-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-video"><video id="video_shortcode_videojs_video4" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title=""><source src="figures/direct_slab.mp4"></video></div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-direct-slab-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Resulting simulation.
</figcaption>
</figure>
</div>
</section>
<section id="related-research" class="level1">
<h1>Related research</h1>
<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-romittiImplementationCellularAutomaton2025" class="csl-entry" role="listitem">
Romitti, Giada S., Alejandro Liberos, María Termenón-Rivas, Javier Barrios-Álvarez De Arcaya, Dolors Serra, Pau Romero, David Calvo, et al. 2025. <span>“Implementation of a <span>Cellular Automaton</span> for Efficient Simulations of Atrial Arrhythmias.”</span> <em>Medical Image Analysis</em> 101 (April): 103484. <a href="https://doi.org/10.1016/j.media.2025.103484">https://doi.org/10.1016/j.media.2025.103484</a>.
</div>
<div id="ref-serraAssessmentRiskVentricular2023" class="csl-entry" role="listitem">
Serra, D., P. Franco, P. Romero, G. Romitti, I. García-Fernández, M. Lozano, A. Liberos, et al. 2023. <span>“Assessment of <span>Risk</span> for <span>Ventricular Tachycardia</span> Based on <span>Extensive Electrophysiology Simulations</span>.”</span> In <em>2023 45th <span>Annual International Conference</span> of the <span>IEEE Engineering</span> in <span>Medicine</span> &amp; <span>Biology Society</span> (<span>EMBC</span>)</em>, 1–4. Sydney, Australia: IEEE. <a href="https://doi.org/10.1109/EMBC40787.2023.10340169">https://doi.org/10.1109/EMBC40787.2023.10340169</a>.
</div>
<div id="ref-serraPersonalizedFastElectrophysiology2022" class="csl-entry" role="listitem">
Serra, Dolors, Paula Franco, Pau Romero, Ignacio García-Fernández, Miguel Lozano, David Soto, Diego Penela, Antonio Berruezo, Oscar Camara, and Rafael Sebastian. 2022. <span>“Personalized <span>Fast Electrophysiology Simulations</span> to <span>Evaluate Arrhythmogenicity</span> of <span>Ventricular Slow Conduction Channels</span>.”</span> In <em>Statistical <span>Atlases</span> and <span>Computational Models</span> of the <span>Heart</span>. <span>Regular</span> and <span>CMRxMotion Challenge Papers</span></em>, edited by Oscar Camara, Esther Puyol-Antón, Chen Qin, Maxime Sermesant, Avan Suinesiaputra, Shuo Wang, and Alistair Young, 13593:56–64. Cham: Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-031-23443-9_6">https://doi.org/10.1007/978-3-031-23443-9_6</a>.
</div>
<div id="ref-serraUnsupervisedStratificationPatients2025" class="csl-entry" role="listitem">
Serra, Dolors, Pau Romero, Paula Franco, Ignacio Bernat, Miguel Lozano, Ignacio Garcia-Fernandez, David Soto, Antonio Berruezo, Oscar Camara, and Rafael Sebastian. 2025. <span>“Unsupervised <span>Stratification</span> of <span>Patients With Myocardial Infarction Based</span> on <span>Imaging</span> and <span>In-Silico Biomarkers</span>.”</span> <em>IEEE Transactions on Medical Imaging</em> 44 (12): 4762–74. <a href="https://doi.org/10.1109/TMI.2025.3582383">https://doi.org/10.1109/TMI.2025.3582383</a>.
</div>
<div id="ref-serraAutomataBasedCardiacElectrophysiology2022" class="csl-entry" role="listitem">
Serra, Dolors, Pau Romero, Ignacio Garcia-Fernandez, Miguel Lozano, Alejandro Liberos, Miguel Rodrigo, Alfonso Bueno-Orovio, Antonio Berruezo, and Rafael Sebastian. 2022. <span>“An <span>Automata-Based Cardiac Electrophysiology Simulator</span> to <span>Assess Arrhythmia Inducibility</span>.”</span> <em>Mathematics</em> 10 (8): 1293. <a href="https://doi.org/10.3390/math10081293">https://doi.org/10.3390/math10081293</a>.
</div>
<div id="ref-serraPatientStratificationBased2024" class="csl-entry" role="listitem">
Serra, Dolors, Pau Romero, Miguel Lozano, Ignacio Garcia-Fernandez, Diego Penela, Antonio Berruezo, Oscar Camara, Miguel Rodrigo, Miriam Gil, and Rafael Sebastian. 2024. <span>“Patient <span>Stratification Based</span> on <span>Fast Simulation</span> of <span>Cardiac Electrophysiology</span> on <span>Digital Twins</span>.”</span> In <em>Statistical <span>Atlases</span> and <span>Computational Models</span> of the <span>Heart</span>. <span>Regular</span> and <span>CMRxRecon Challenge Papers</span></em>, edited by Oscar Camara, Esther Puyol-Antón, Maxime Sermesant, Avan Suinesiaputra, Qian Tao, Chengyan Wang, and Alistair Young, 14507:35–43. Cham: Springer Nature Switzerland. <a href="https://doi.org/10.1007/978-3-031-52448-6_4">https://doi.org/10.1007/978-3-031-52448-6_4</a>.
</div>
</div>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@article{serra2022,
  author = {Serra, Dolors and Romero, Pau and Garcia-Fernandez, Ignacio
    and Lozano, Miguel and Liberos, Alejandro and Rodrigo, Miguel and
    Bueno-Orovio, Alfonso and Berruezo, Antonio and Sebastian, Rafael},
  publisher = {Multidisciplinary Digital Publishing Institute},
  title = {An {Automata-Based} {Cardiac} {Electrophysiology} {Simulator}
    to {Assess} {Arrhythmia} {Inducibility}},
  journal = {Mathematics},
  volume = {10},
  number = {8},
  pages = {1293},
  date = {2022-04-13},
  url = {https://doi.org/10.3390/math10081293},
  doi = {10.3390/math10081293},
  issn = {2227-7390},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-serra2022" class="csl-entry quarto-appendix-citeas" role="listitem">
Serra, Dolors, Pau Romero, Ignacio Garcia-Fernandez, Miguel Lozano,
Alejandro Liberos, Miguel Rodrigo, Alfonso Bueno-Orovio, Antonio
Berruezo, and Rafael Sebastian. 2022. <span>“An Automata-Based Cardiac
Electrophysiology Simulator to Assess Arrhythmia Inducibility.”</span>
<em>Mathematics</em> 10 (April): 1293. <a href="https://doi.org/10.3390/math10081293">https://doi.org/10.3390/math10081293</a>.
</div></div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>videojs(video_shortcode_videojs_video1);</script>
<script>videojs(video_shortcode_videojs_video2);</script>
<script>videojs(video_shortcode_videojs_video3);</script>
<script>videojs(video_shortcode_videojs_video4);</script>




</body></html>